---
title: "Neighborhood Indicators" 
---

This is the census tract that makes up our neighborhood.

```{r echo = FALSE, warning = FALSE, message = FALSE}
#| title: "Census Tracts of Madison"
#| #| fig-width: 12

library(sf) 
library(ggplot2) 
library(dplyr)
library(magrittr)
library(tidyr)
library(gt)

meta_2024 <- read.csv(file = "indicators/nip_tr_24/nip_metadata_24.csv") 
shp_2024 <- sf::read_sf(dsn = "indicators/nip_tr_24/nip_tr_24.shp", stringsAsFactors = FALSE) 
BR_boundary <- sf::read_sf(dsn = "indicators/Badger_Rock_Boundary.kml")

lakes <- sf::read_sf(dsn = "indicators/LakesPonds/LakesPonds.shp") %>% dplyr::filter(HYDTYPE == "Lake") %>% dplyr::filter(NAME %in% c("Lake Mendota", "Lake Monona", "Lake Wingra")) %>% head(-1)

# geo_id for Badger Rock is 55025001502, Madison is Mdsn2024

N <- shp_2024 %>% dplyr::filter(geo == "55025001502") 
N$NAME <- "Badger Rock"

MDSN <- shp_2024 %>% dplyr::filter(geo == "Mdsn2024")
MDSN$NAME <- "Madison"

# Everything except the whole city and our neighborhood

all_other_neighborhoods <- shp_2024 %>% dplyr::filter(!geo %in% c("Mdsn2024", "55025001502"))

ggplot() + 
  ggtitle("Madison Total Population by Census Tracts") +
  geom_sf(data = all_other_neighborhoods, aes(fill = tot_pop), show.legend = TRUE) + 
  geom_sf(data = N, color = "purple", aes(fill = tot_pop), linewidth = 1) + 
  # This helped figure out what geo id our census tract had
  # geom_sf_text(data = N, aes(label = geo), size = 2.5, nudge_y = -0.012) +
  geom_sf(data = lakes, color = "blue") + geom_sf_text(data = lakes, aes(label = NAME), size = 2.0) + 
  scale_fill_distiller(palette = "BuPu", direction = 1) + 
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank(), 
        axis.ticks = element_blank(), 
        rect = element_blank(), 
        axis.title.y=element_blank(), 
        axis.title.x=element_blank(),
        plot.background = element_rect(colour = "black", fill=NA, size=3))

```

This census tract is not a perfect fit for our neighborhood boundaries, but we can see that when we overlay on top of a map that the area covers all of our neighborhood boundary except the part that is in Fitchburg, and the excess area is mainly undeveloped save for the Highland Manor area, so it remains a decent representation of our neighborhood.

![](indicators/Boundary_Census_Overlay.png)

```{r echo = FALSE, warning = FALSE, message = FALSE}

meta <- read.csv("indicators/nip_tr_24/nip_metadata_24.csv")
tr <- read.csv(file = "indicators/nip_tr_24/nip_tr_24_data.csv", header = TRUE, sep = ",", na.strings = "NA") %>% dplyr::filter(geo_id %in% c("55025001502", "madison")) %>% select(-geo_id) %>% as.data.frame()

# Some data is NA for the tracts even though all is present in block groups.
# geo_id for Badger Rock is 550250015022, 550250015023, 550250015024
bg <- read.csv(file = "indicators/nip_bg_24/nip_bg_24_data.csv", header = TRUE, sep = ",", na.strings = "NA") %>% dplyr::filter(geo_id %in% c("550250015022", "550250015023", "550250015024","madison")) %>% select(-geo_id) %>% as.data.frame()


ind <- tr
bg_ind <- bg


colnames(ind)[colnames(ind) == "geo_type"] <- "Area"

# Calculate Percent Families in Poverty from block groups to get new percentage for the Census Tract
# First I did this against total population, but I realized this was percent families, not percent of people. Leave this here for a bit until I can be certain.
# pp <- bg_ind[1:3,c("pc_fmpv", "tot_pop")]
# pp$num_pov <- (pp$pc_fmpv/100)*pp$tot_pop
# tot_pov <- sum(pp$num_pov)
# census_pop <- sum(pp$tot_pop) # This is 4071 vs. 4070 in census
# ind$pc_fmpv[1] <- round((tot_pov/census_pop)*100, 1)

pp <- bg_ind[1:3,c("pc_fmpv", "hh")]
pp$num_pov <- (pp$pc_fmpv/100)*pp$hh
tot_pov <- sum(pp$num_pov)
census_pop <- sum(pp$hh) # This is 1667 vs. 1666 in census
ind$pc_fmpv[1] <- round((tot_pov/census_pop)*100, 1)

# Calculate Unemployment from block groups to get new percentage for the Census Tract
unem <- bg_ind[1:3,c("pc_unem", "tot_pop")]
unem$num_umen <- (unem$pc_unem/100)*unem$tot_pop
tot_umen <- sum(unem$num_umen)
census_pop <- sum(unem$tot_pop) # This is 4071 vs. 4070 in census
ind$pc_unem[1] <- round((tot_umen/census_pop)*100, 1)

# Put percentage signs in front of percentages
paste_percent <- function(col) (paste(col, "%"))
pcnt_cols <- grep(x = colnames(ind), pattern = "pc_")
ind %<>% mutate(across(pcnt_cols, paste_percent)) %>%
  # These columns have NA for both data points
  select(-c("foreclsr", "yrblt_mdn")) %>%
  # These columns have NA for all three block groups and the census tract
  select(-c("pc_no_vhcl", "pc_alt_trn"))


# Rename indicators
recode_vec <- setNames(meta$variable, meta$name)
name_match <-  match(names(ind), meta$variable)
ind %<>% rename(any_of(recode_vec))

# Pivot Table
ind <- data.frame(t(ind[-1])) %>% relocate(X2)
## Fix rows that have no data
#
colnames(ind) <- c("City of Madison", "Badger Rock")

# Make row names an actual column
ind$Measure <- row.names(ind) 
id <- c(rep("Census 2020", 15), rep("Housing", 12), rep("Public Safety", 7), rep("Health", 2), rep("Education", 9), rep("Economy", 4), rep("Transportation", 3))

gt(data = ind, rowname_col = "Measure") %>% 
  tab_header("2024 Neighborhood Indicators") %>% 
  tab_row_group(label = "Census 2020", rows = id == "Census 2020") %>%   
  tab_row_group(label = "Housing", rows = id == "Housing") %>% 
  tab_row_group(label = "Public Safety", rows = id == "Public Safety") %>% 
  tab_row_group(label = "Health", rows = id == "Health") %>% 
  tab_row_group(label = "Education", rows = id == "Education") %>% 
  tab_row_group(label = "Economy", rows = id == "Economy") %>% 
  tab_row_group(label = "Transportation", rows = id == "Transportation") %>% 
  row_group_order(groups = c("Census 2020", "Housing", "Public Safety", "Health", "Education","Economy","Transportation")) %>%
  tab_style(
    style = list(cell_fill(color = "gray75"), cell_text(size = "larger")),  
    locations = cells_row_groups())

# This isn't quite done yet - I want to remove rows with NA (-5), possibly make everything into percents relative to total population, and put little red/green arrows to display the percent difference between us and the city

```

Values with a "-5" are missing data for at least one of the component block groups. Data were calculated if all data was present for each block group but was missing for the census tract.

Data Sources:

[Neighborhood Indicator Data (2024)](https://madison.apl.wisc.edu/)

[Lake Boundaries](https://gis-countyofdane.opendata.arcgis.com/pages/water-resources)
